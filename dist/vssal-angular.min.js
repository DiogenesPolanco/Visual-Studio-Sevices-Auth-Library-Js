/*! vssal-angular v0.0.1 2017-01-22 */
!function(){"use strict";if("undefined"!=typeof module&&module.exports&&(module.exports.inject=function(a){return new ContextVssal(a)}),angular){var a=angular.module("vssalAngular",[]);a.provider("vssalAuthenticationService",function(){var a=null,b={isAuthenticated:!1,userName:"",loginError:"",profile:""},c=function(){a.getCachedToken().then(function(c){b.isAuthenticated=null!==c&&c.length>0,b.isAuthenticated&&a.getCachedUser().then(function(a){var c=a||{userName:""};b.userName=c.userName,b.profile=c.profile})})};this.init=function(b,d){if(!b)throw new Error("You must set configOptions, when calling init");var e=window.location.hash,f=window.location.href;e&&(f=f.replace(e,"")),b.redirectUri=b.redirectUri||f,b.postLogoutRedirectUri=b.postLogoutRedirectUri||f,b.isAngular=!0,d&&d.interceptors&&d.interceptors.push("ProtectedResourceInterceptor"),a=new ContextVssal(b),c()},this.$get=["$rootScope","$window","$q","$location","$timeout","$injector",function(d,e,f,g,h,i){function j(a,b){return b.requireVSOLogin?a.requireVSOLogin!==!1:!!a.requireVSOLogin}function k(a){var b=null,c=[];if(a.hasOwnProperty("parent"))for(b=a;b;)c.unshift(b),b=i.get("$state").get(b.parent);else for(var d=a.name.split("."),e=0,f=d[0];e<d.length;e++)b=i.get("$state").get(f),b&&c.push(b),f+="."+d[e+1];return c}var l=function(f,g,j){a.verbose("Location change event from "+j+" to "+g);var k=e.location.hash;if(a.isCallback(k)&&(a.verbose("Processing the hash: "+k),!b.isAuthenticated)){var l=i.get("vssalAuthenticationService");l.acquireToken().then(function(c){c&&b.userName?(b.isAuthenticated=!0,d.$broadcast("vssal:loginSuccess",a._getItem(a.CONSTANTS.STORAGE.ACCESS_TOKEN))):d.$broadcast("vssal:loginFailure",a._getItem(a.CONSTANTS.STORAGE.ERROR_DESCRIPTION),a._getItem(a.CONSTANTS.STORAGE.ERROR))})}h(function(){c(),d.userInfo=b},1)},m=function(){a.info("Login event for:"+g.$$url),a.config&&a.config.localLoginUrl?g.path(a.config.localLoginUrl):(a.info("Start login at:"+window.location.href),d.$broadcast("vssal:loginRedirect"),a.login())},n=function(c,d){if(d&&d.$$route)if(j(d.$$route,a.config))b.isAuthenticated||a.loginInProgress()||(a.info("Route change event for:"+g.$$url),m());else{var e;e="function"==typeof d.$$route.templateUrl?d.$$route.templateUrl(d.params):d.$$route.templateUrl}},o=function(c,d,e,f,h){if(d)for(var i=k(d),l=null,n=0;n<i.length;n++)if(l=i[n],j(l,a.config))b.isAuthenticated||a._renewActive||a.loginInProgress()||(a.info("State change event for:"+g.$$url),m());else if(l.templateUrl){var o;o="function"==typeof l.templateUrl?l.templateUrl(e):l.templateUrl}},p=function(b,c,d,e,f,g){a.verbose("State change error occured. Error: "+JSON.stringify(g)),g&&g.data&&(a.info("Setting defaultPrevented to true if state change error occured because vssal rejected a request. Error: "+g.data),b.preventDefault())};return d.$on("$routeChangeStart",n),d.$on("$stateChangeStart",o),d.$on("$locationChangeStart",l),d.$on("$stateChangeError",p),d.userInfo=b,{config:a.config,login:function(){a.login()},loginInProgress:function(){return a.loginInProgress()},logOut:function(){a.logOut()},getCachedToken:function(){return a.getCachedToken()},userInfo:b,acquireToken:function(){var b=f.defer();return a.acquireToken().then(function(c){c?(d.$broadcast("vssal:acquireTokenSuccess",c),b.resolve(c)):(d.$broadcast("vssal:acquireTokenFailure"),a.error("Error when acquiring token"),b.reject("Error when acquiring token"))}),b.promise},getUser:function(){var b=f.defer();return a.getUser(function(c,d){c?(a.error("Error when getting user",c),b.reject(c)):b.resolve(d)}),b.promise},clearCache:function(){a.clearCache()},info:function(b){a.info(b)},verbose:function(b){a.verbose(b)}}}]}),a.factory("ProtectedResourceInterceptor",["vssalAuthenticationService","$q","$rootScope",function(a,b,c){return{request:function(c){if(c){c.headers=c.headers||{};var d=a.getCachedToken();if(d)return a.info("Token is available for this url "+c.url),c.headers.Authorization="Bearer "+d,c;if(a.loginInProgress())return a.info("login is in progress."),c.data="login in progress, cancelling the request for "+c.url,b.reject(c);var e=b.defer();return a.acquireToken().then(function(b){b&&_oauthData.userName?(a.verbose("Token is available"),c.headers.Authorization="Bearer "+b,e.resolve(c)):e.reject(c)}),e.promise}},responseError:function(d){if(a.info("Getting error in the response: "+JSON.stringify(d)),d)return 401===d.status?c.$broadcast("vssal:notAuthorized",d):c.$broadcast("vssal:errorResponse",d),b.reject(d)}}}])}else console.error("Angular.JS is not included")}();