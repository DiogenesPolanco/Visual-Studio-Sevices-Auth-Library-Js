/*! vssal-angular v0.0.1 2017-01-22 */
!function(){"use strict";if("undefined"!=typeof module&&module.exports&&(module.exports.inject=function(a){return new ContextVssal(a)}),angular){var a=angular.module("vssalAngular",[]);a.provider("vssalAuthenticationService",function(){var a=null,b={isAuthenticated:!1,userName:"",loginError:"",profile:""},c=function(){a.getCachedToken().then(function(c){b.isAuthenticated=null!==c&&c.length>0,b.isAuthenticated&&a.getCachedUser().then(function(a){var c=a||{userName:""};b.userName=c.userName,b.profile=c.profile})})};this.init=function(b,d){if(!b)throw new Error("You must set configOptions, when calling init");var e=window.location.hash,f=window.location.href;e&&(f=f.replace(e,"")),b.redirectUri=b.redirectUri||f,b.postLogoutRedirectUri=b.postLogoutRedirectUri||f,b.isAngular=!0,d&&d.interceptors&&d.interceptors.push("ProtectedResourceInterceptor"),a=new ContextVssal(b),c()},this.$get=["$rootScope","$window","$q","$location","$timeout","$injector",function(c,d,e,f,g,h){function i(a,b){return b.requireVSOLogin?a.requireVSOLogin!==!1:!!a.requireVSOLogin}function j(a){var b=null,c=[];if(a.hasOwnProperty("parent"))for(b=a;b;)c.unshift(b),b=h.get("$state").get(b.parent);else for(var d=a.name.split("."),e=0,f=d[0];e<d.length;e++)b=h.get("$state").get(f),b&&c.push(b),f+="."+d[e+1];return c}var k=function(e,f,g){a.verbose("Location change event from "+g+" to "+f);var i=d.location.hash;if(a.isCallback(i)&&(a.verbose("Processing the hash: "+i),!b.isAuthenticated)){var j=h.get("vssalAuthenticationService");j.acquireToken().then(function(d){d&&b.userName?(b.isAuthenticated=!0,c.$broadcast("vssal:loginSuccess",a._getItem(a.CONSTANTS.STORAGE.ACCESS_TOKEN))):c.$broadcast("vssal:loginFailure",a._getItem(a.CONSTANTS.STORAGE.ERROR_DESCRIPTION),a._getItem(a.CONSTANTS.STORAGE.ERROR))})}},l=function(){a.info("Login event for:"+f.$$url),a.config&&a.config.localLoginUrl?f.path(a.config.localLoginUrl):(a.info("Start login at:"+window.location.href),c.$broadcast("vssal:loginRedirect"),a.login())},m=function(c,d){if(d&&d.$$route)if(i(d.$$route,a.config))b.isAuthenticated||a.loginInProgress()||(a.info("Route change event for:"+f.$$url),l());else{var e;e="function"==typeof d.$$route.templateUrl?d.$$route.templateUrl(d.params):d.$$route.templateUrl}},n=function(c,d,e,g,h){if(d)for(var k=j(d),m=null,n=0;n<k.length;n++)if(m=k[n],i(m,a.config))b.isAuthenticated||a._renewActive||a.loginInProgress()||(a.info("State change event for:"+f.$$url),l());else if(m.templateUrl){var o;o="function"==typeof m.templateUrl?m.templateUrl(e):m.templateUrl}},o=function(b,c,d,e,f,g){a.verbose("State change error occured. Error: "+JSON.stringify(g)),g&&g.data&&(a.info("Setting defaultPrevented to true if state change error occured because vssal rejected a request. Error: "+g.data),b.preventDefault())};return c.$on("$routeChangeStart",m),c.$on("$stateChangeStart",n),c.$on("$locationChangeStart",k),c.$on("$stateChangeError",o),c.userInfo=b,{config:a.config,login:function(){a.login()},loginInProgress:function(){return a.loginInProgress()},logOut:function(){a.logOut()},getCachedToken:function(){return a.getCachedToken()},userInfo:b,acquireToken:function(){var b=e.defer();return a.acquireToken().then(function(d){d?(c.$broadcast("vssal:acquireTokenSuccess",d),b.resolve(d)):(c.$broadcast("vssal:acquireTokenFailure"),a.error("Error when acquiring token"),b.reject("Error when acquiring token"))}),b.promise},getUser:function(){var b=e.defer();return a.getUser(function(c,d){c?(a.error("Error when getting user",c),b.reject(c)):b.resolve(d)}),b.promise},clearCache:function(){a.clearCache()},info:function(b){a.info(b)},verbose:function(b){a.verbose(b)}}}]}),a.factory("ProtectedResourceInterceptor",["vssalAuthenticationService","$q","$rootScope",function(a,b,c){return{request:function(c){if(c){c.headers=c.headers||{};var d=a.getCachedToken();if(d)return a.info("Token is available for this url "+c.url),c.headers.Authorization="Bearer "+d,c;if(a.loginInProgress())return a.info("login is in progress."),c.data="login in progress, cancelling the request for "+c.url,b.reject(c);var e=b.defer();return a.acquireToken().then(function(b){b&&_oauthData.userName?(a.verbose("Token is available"),c.headers.Authorization="Bearer "+b,e.resolve(c)):e.reject(c)}),e.promise}},responseError:function(d){if(a.info("Getting error in the response: "+JSON.stringify(d)),d)return 401===d.status?c.$broadcast("vssal:notAuthorized",d):c.$broadcast("vssal:errorResponse",d),b.reject(d)}}}])}else console.error("Angular.JS is not included")}();